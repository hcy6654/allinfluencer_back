<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.allinfluencer.backend.mypage.infrastructure.mybatis.advertiser.AdvertiserCandidatesReadMapper">

    <select id="selectJobPostRef"
            resultType="com.allinfluencer.backend.mypage.infrastructure.mybatis.advertiser.AdvertiserCandidatesReadMapper$JobPostRefRow">
        SELECT jp.id, jp."title"
        FROM job_posts jp
        WHERE jp.id = #{jobPostId}
          AND jp."userId" = #{userId}
        LIMIT 1
    </select>

    <select id="selectApplicants"
            resultType="com.allinfluencer.backend.mypage.infrastructure.mybatis.advertiser.AdvertiserCandidatesReadMapper$ApplicantRow">
        SELECT
            a.id,
            a."status"::text AS status,
            a."createdAt" AS appliedAt,
            u.id AS influencerId,
            u."displayName" AS influencerDisplayName,
            u."avatar" AS influencerAvatar,
            ip."headline" AS headline,
            ip."followers" AS followers,
            ip."avgEngagement" AS avgEngagement,
            ip."categories" AS categories
        FROM applications a
        JOIN job_posts jp ON jp.id = a."jobPostId"
        JOIN users u ON u.id = a."userId"
        LEFT JOIN influencer_profiles ip ON ip."userId" = u.id
        WHERE a."jobPostId" = #{jobPostId}
          AND jp."userId" = #{userId}
        <if test="status != null and status != ''">
            AND a."status" = CAST(#{status} AS "ApplicationStatus")
        </if>
        <if test="cursor != null">
            AND a."createdAt" &lt; #{cursor}
        </if>
        ORDER BY a."createdAt" DESC, a.id DESC
        LIMIT #{limitPlusOne}
    </select>

    <select id="selectOffers"
            resultType="com.allinfluencer.backend.mypage.infrastructure.mybatis.advertiser.AdvertiserCandidatesReadMapper$OfferRow">
        SELECT
            o.id,
            o."status"::text AS status,
            o."createdAt" AS offeredAt,
            u.id AS influencerId,
            u."displayName" AS influencerDisplayName,
            u."avatar" AS influencerAvatar,
            ip."headline" AS headline,
            ip."followers" AS followers,
            ip."avgEngagement" AS avgEngagement,
            ip."categories" AS categories
        FROM offers o
        JOIN users u ON u.id = o."receiverId"
        LEFT JOIN influencer_profiles ip ON ip."userId" = u.id
        WHERE o."jobPostId" = #{jobPostId}
          AND o."senderId" = #{userId}
        <if test="status != null and status != ''">
            AND o."status" = CAST(#{status} AS "OfferStatus")
        </if>
        <if test="cursor != null">
            AND o."createdAt" &lt; #{cursor}
        </if>
        ORDER BY o."createdAt" DESC, o.id DESC
        LIMIT #{limitPlusOne}
    </select>

</mapper>
